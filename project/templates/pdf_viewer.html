<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/x-icon">
    <!-- Load the UMD build of pdf.js from a CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body, h1, p {
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #555;
        }

        #pdf-container {
            margin: 20px 0;
            background: #fff;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            position: relative;
        }

        #pdf-canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        #controls {
            text-align: center;
            margin: 20px 0;
        }

        #controls button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #controls button:hover {
            background-color: #0056b3;
        }

        #annotation-tools {
            text-align: center;
            margin-bottom: 20px;
        }

        #annotation-tools button {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #annotation-tools button:hover {
            background-color: #218838;
        }

        .annotation-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 5px; /* Small gap between replies */
            max-width: 300px;  /* Max width to prevent overflow */
        }

        .comment {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            z-index: 10;
            width: 100%;
        }

        .comment div {
            margin-bottom: 5px;
            font-style: italic;
            font-size: 12px;
            color: #666;
        }

        .comment textarea {
            width: 100%;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
            resize: none;
            overflow: hidden;
            box-sizing: border-box;
            padding: 5px;
            background-color: #f9f9f9;
        }

        .comment button {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .comment button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <h1>PDF Viewer</h1>
    <p>How to use: Use the buttons to navigate between pages. Use "Add comment" and click on the location where you want to comment. Write your comment and press enter to submit. If you need to delete your comment, you will be prompted to enter your full name again to prevent accidental deletion of other students' comments. Use the reply button to add to an existing conversation.</p>

    <!-- PDF Container -->
    <div id="pdf-container">
        <canvas id="pdf-canvas"></canvas>
    </div>

    <!-- Page Navigation Controls -->
    <div id="controls">
        <button id="prev-page">Previous Page</button>
        <span>Page: <span id="page-num"></span> / <span id="page-count"></span></span>
        <button id="next-page">Next Page</button>
    </div>

    <!-- Annotation Tools -->
    <div id="annotation-tools">
        <button id="comment-btn">Add Comment</button>
    </div>

    <!-- Set up pdf.js and render the PDF -->
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";

        const url = `/get_pdf/{{ pdf }}`;
        const week = "{{ pdf.split('.')[0] }}";
        let pdfDoc = null,
            pageNum = 1,
            scale = 1.5,
            canvas = document.getElementById('pdf-canvas'),
            ctx = canvas.getContext('2d');

        let studentName = prompt("Please enter your name:");
        if (!studentName) {
            alert("Name is required to comment.");
            studentName = "Anonymous";
        }

        let isCommenting = false;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch PDF");
                }
                return response.arrayBuffer();
            })
            .then(data => pdfjsLib.getDocument({ data }).promise)
            .then(pdfDoc_ => {
                pdfDoc = pdfDoc_;
                document.getElementById('page-count').textContent = pdfDoc.numPages;
                renderPage(pageNum);
            })
            .catch(error => {
                console.error("Error fetching or rendering PDF:", error);
            });

        function renderPage(num) {
            pdfDoc.getPage(num).then(page => {
                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                page.render(renderContext).promise.then(() => {
                    document.getElementById('page-num').textContent = num;
                    loadAnnotations(week, num);
                }).catch(error => {
                    console.error("Error rendering page:", error);
                });
            }).catch(error => {
                console.error("Error getting page:", error);
            });
        }

        document.getElementById('prev-page').addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            clearAnnotations();
            renderPage(pageNum);
        });

        document.getElementById('next-page').addEventListener('click', () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            clearAnnotations();
            renderPage(pageNum);
        });

        document.getElementById('comment-btn').addEventListener('click', () => {
            isCommenting = true;
        });

        canvas.addEventListener('click', (e) => {
            if (isCommenting) {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / rect.width;
                const y = (e.clientY - rect.top) / rect.height;

                const timestamp = new Date().toLocaleString();
                const comment = createAnnotation('comment', x, y, 0.2, 0.05, '', studentName, timestamp);

                document.getElementById('pdf-container').appendChild(comment);

                const inputElement = comment.querySelector('textarea');
                if (inputElement) {
                    inputElement.focus();
                }

                isCommenting = false;
            }
        });

        function createAnnotation(type, left, top, width, height, commentText = '', author = '', timestamp = '', parent = null, isLocked = false) {
    const annotationContainer = document.createElement('div');
    annotationContainer.className = 'annotation-container';
    annotationContainer.style.left = `${left * 100}%`;
    annotationContainer.style.top = `${top * 100}%`;

    if (parent) {
        const parentRect = parent.getBoundingClientRect();
        const canvasRect = document.getElementById('pdf-canvas').getBoundingClientRect();

        const replyTop = (parentRect.bottom - canvasRect.top + 10) / canvasRect.height;
        annotationContainer.style.top = `${replyTop * 100}%`;

        // Add a "Replying to" label
        const parentAuthor = parent.querySelector('div').textContent.split(' at ')[0].replace('By: ', '');
        const replyLabel = document.createElement('div');
        replyLabel.style.fontStyle = 'italic';
        replyLabel.style.fontSize = '12px';
        replyLabel.style.color = '#666';
        replyLabel.textContent = `Replying to ${parentAuthor}`;
        annotationContainer.appendChild(replyLabel);
    }

    const annotation = document.createElement('div');
    annotation.className = 'comment';
    annotation.style.width = 'auto';
    annotation.style.minWidth = '150px';
    annotation.style.height = 'auto';
    annotation.style.padding = '5px';
    annotation.style.border = '1px solid #ccc';
    annotation.style.backgroundColor = 'white';
    annotation.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
    annotationContainer.appendChild(annotation);

    document.getElementById('pdf-container').appendChild(annotationContainer);

    const authorElement = document.createElement('div');
    authorElement.style.fontStyle = 'italic';
    authorElement.style.fontSize = '12px';
    authorElement.textContent = `By: ${author} at ${timestamp}`;
    annotation.appendChild(authorElement);

    let contentElement;
    if (isLocked) {
        contentElement = document.createElement('div');
        contentElement.textContent = commentText;
        contentElement.style.whiteSpace = 'pre-wrap';
    } else {
        contentElement = document.createElement('textarea');
        contentElement.placeholder = 'Enter comment...';
        contentElement.value = commentText;
        contentElement.style.width = '100%';
        contentElement.style.height = '50px';
        contentElement.style.resize = 'none';

        contentElement.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = `${this.scrollHeight}px`;
        });

        contentElement.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();

                let parentId = '';
                if (parent) {
                    parentId = parent.getAttribute('data-id');
                }

                saveAnnotation(type, left, top, contentElement.scrollWidth, contentElement.scrollHeight, contentElement.value, author, timestamp, parentId);

                const commentTextDiv = document.createElement('div');
                commentTextDiv.textContent = contentElement.value;
                commentTextDiv.style.whiteSpace = 'pre-wrap';
                commentTextDiv.style.padding = '5px';
                annotation.replaceChild(commentTextDiv, contentElement);
            }
        });
    }

    annotation.appendChild(contentElement);

    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'Delete';
    deleteButton.style.marginLeft = '10px';
    deleteButton.style.fontSize = '12px';
    deleteButton.addEventListener('click', () => {
        const confirmName = prompt("To delete, confirm your name:");
        if (confirmName === author) {
            annotationContainer.remove();
            deleteAnnotation(type, left, top, width, height, author);
        } else {
            alert("You can only delete your own comments.");
        }
    });
    annotation.appendChild(deleteButton);

    const replyButton = document.createElement('button');
    replyButton.textContent = 'Reply';
    replyButton.style.marginLeft = '10px';
    replyButton.style.fontSize = '12px';
    replyButton.addEventListener('click', () => {
        const replyTimestamp = new Date().toLocaleString();
        const reply = createAnnotation('comment', left, top + 0.05, 0.2, 0.05, '', studentName, replyTimestamp, annotationContainer);
        document.getElementById('pdf-container').appendChild(reply);
        const replyInputElement = reply.querySelector('textarea');
        if (replyInputElement) {
            replyInputElement.focus();
        }
    });
    annotation.appendChild(replyButton);

    return annotationContainer;
}



        function saveAnnotation(type, left, top, width, height, comment, author, timestamp, parentId) {
            fetch(`/annotate/${week}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    page: pageNum,
                    type,
                    left,
                    top,
                    width,
                    height,
                    comment,
                    author,
                    timestamp,
                    parent_id: parentId || '',  // Save the parent ID if it's a reply
                }),
            }).then(response => response.json())
                .then(data => {
                    console.log('Annotation saved:', data);
                });
        }

        function deleteAnnotation(type, left, top, width, height, author) {
            fetch(`/delete_annotation/${week}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    page: pageNum,
                    type,
                    left,
                    top,
                    width,
                    height,
                    author,
                }),
            }).then(response => response.json())
                .then(data => {
                    console.log('Annotation deleted:', data);
                });
        }

        function loadAnnotations(week, page) {
            fetch(`/load_annotations/${week}/${page}`)
                .then(response => response.json())
                .then(data => {
                    data.annotations.forEach(annotationData => {
                        const isLocked = true;
                        const parent = annotationData.parent_id ? document.querySelector(`[data-id="${annotationData.parent_id}"]`) : null;
                        const annotation = createAnnotation(
                            annotationData.type,
                            annotationData.left,
                            annotationData.top,
                            annotationData.width,
                            annotationData.height,
                            annotationData.comment,
                            annotationData.author,
                            annotationData.timestamp,
                            parent,
                            isLocked
                        );
                        document.getElementById('pdf-container').appendChild(annotation);
                    });
                });
        }

        function clearAnnotations() {
            const annotations = document.querySelectorAll('.annotation-container');
            annotations.forEach(annotation => annotation.remove());
        }
    </script>
</body>
</html>
